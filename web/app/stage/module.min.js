define(function(){"use strict";try{var module=cenozoApp.module("stage",true)}catch(err){console.warn(err);return}angular.extend(module,{identifier:{parent:{subject:"qnaire",column:"qnaire.id"}},name:{singular:"stage",plural:"stages",possessive:"stage's"},columnList:{rank:{column:"stage.rank",title:"Rank",type:"rank"},name:{title:"Name",column:"stage.name"},precondition:{title:"Precondition"},first_module:{title:"First Module",column:"first_module.name"},last_module:{title:"Last Module",column:"last_module.name"},module_count:{title:"Number of Modules"}},defaultOrder:{column:"stage.rank",reverse:false}});module.addInputGroup("",{rank:{title:"Rank",type:"rank",isConstant:"view"},name:{title:"Name",type:"string"},precondition:{title:"Precondition",type:"text",help:"A special expression which restricts whether or not the stage can proceed."},first_module_id:{title:"First Module",type:"enum",help:"Note that you must create at least one module before a stage can be created"},last_module_id:{title:"Last Module",type:"enum",help:"Note that you must create at least one module before a stage can be created"},first_module_rank:{type:"hidden",column:"first_module.rank"},last_module_rank:{type:"hidden",column:"last_module.rank"}});cenozo.providers.directive("cnStageAdd",["CnStageModelFactory","CnHttpFactory",function(CnStageModelFactory,CnHttpFactory){return{templateUrl:module.getFileUrl("add.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnStageModelFactory.root;var cnRecordAddScope=null;$scope.$on("cnRecordAdd linked",function(event,data){cnRecordAddScope=data;cnRecordAddScope.baseCheckFn=cnRecordAddScope.check;cnRecordAddScope.check=async function(property){await cnRecordAddScope.baseCheckFn(property);if(["rank","first_module_id","last_module_id"].includes(property)){var inputArray=cnRecordAddScope.dataArray.findByProperty("title","").inputArray;$scope.model.updateModuleListState(inputArray.findByProperty("key","first_module_id").enumList,inputArray.findByProperty("key","last_module_id").enumList,cnRecordAddScope.record.rank?$scope.model.stageList.findByProperty("rank",cnRecordAddScope.record.rank-1):null,cnRecordAddScope.record.rank?$scope.model.stageList.findByProperty("rank",cnRecordAddScope.record.rank):null,cnRecordAddScope.record.first_module_id,cnRecordAddScope.record.last_module_id)}}})}}}]);cenozo.providers.directive("cnStageList",["CnStageModelFactory",function(CnStageModelFactory){return{templateUrl:module.getFileUrl("list.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnStageModelFactory.root}}}]);cenozo.providers.directive("cnStageView",["CnStageModelFactory",function(CnStageModelFactory){return{templateUrl:module.getFileUrl("view.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){if(angular.isUndefined($scope.model))$scope.model=CnStageModelFactory.root}}}]);cenozo.providers.factory("CnStageAddFactory",["CnBaseAddFactory",function(CnBaseAddFactory){var object=function(parentModel){CnBaseAddFactory.construct(this,parentModel);this.onNew=async function(record){await this.$$onNew(record);await this.parentModel.updateStageAndModuleList();this.parentModel.metadata.columnList.first_module_id.enumList.forEach(function(item){item.disabled=true});this.parentModel.metadata.columnList.last_module_id.enumList.forEach(function(item){item.disabled=true})}};return{instance:function(parentModel){return new object(parentModel)}}}]);cenozo.providers.factory("CnStageListFactory",["CnBaseListFactory",function(CnBaseListFactory){var object=function(parentModel){CnBaseListFactory.construct(this,parentModel)};return{instance:function(parentModel){return new object(parentModel)}}}]);cenozo.providers.factory("CnStageViewFactory",["CnBaseViewFactory",function(CnBaseViewFactory){var object=function(parentModel,root){CnBaseViewFactory.construct(this,parentModel,root);angular.extend(this,{onView:async function(force){await this.$$onView(force);await this.parentModel.updateStageAndModuleList();this.parentModel.updateModuleListState(this.parentModel.metadata.columnList.first_module_id.enumList,this.parentModel.metadata.columnList.last_module_id.enumList,this.parentModel.stageList.findByProperty("rank",this.record.rank-1),this.parentModel.stageList.findByProperty("rank",this.record.rank+1),this.record.first_module_id,this.record.last_module_id)},onPatch:async function(data){if(angular.isDefined(data.first_module_id)){var self=this;this.parentModel.metadata.columnList.last_module_id.enumList.forEach(function(item){item.disabled=self.record.first_module_rank>=item.rank})}else if(angular.isDefined(data.last_module_id)){var self=this;this.parentModel.metadata.columnList.first_module_id.enumList.forEach(function(item){item.disabled=self.record.last_module_rank<=item.rank})}this.$$onPatch(data)}})};return{instance:function(parentModel,root){return new object(parentModel,root)}}}]);cenozo.providers.factory("CnStageModelFactory",["CnBaseModelFactory","CnStageAddFactory","CnStageListFactory","CnStageViewFactory","CnHttpFactory",function(CnBaseModelFactory,CnStageAddFactory,CnStageListFactory,CnStageViewFactory,CnHttpFactory){var object=function(root){var self=this;CnBaseModelFactory.construct(this,module);this.addModel=CnStageAddFactory.instance(this);this.listModel=CnStageListFactory.instance(this);this.viewModel=CnStageViewFactory.instance(this,root);angular.extend(this,{stageList:null,updateStageAndModuleList:async function(){var response=await CnHttpFactory.instance({path:this.getServiceCollectionPath(),data:{select:{column:["rank",{table:"first_module",column:"rank",alias:"first_module_rank"},{table:"last_module",column:"rank",alias:"last_module_rank"}]},modifier:{join:[{table:"module",onleft:"stage.first_module_id",onright:"first_module.id",alias:"first_module"},{table:"module",onleft:"stage.last_module_id",onright:"last_module.id",alias:"last_module"}],order:"stage.rank"}}}).query();this.stageList=response.data;var parent=this.getParentIdentifier();var response=await CnHttpFactory.instance({path:angular.isDefined(parent.subject)?[parent.subject,parent.identifier,"module"].join("/"):this.getServiceCollectionPath().replace("stage","module"),data:{select:{column:["id","rank","name"]},modifier:{order:"rank"}}}).query();this.metadata.columnList.first_module_id.enumList=[];this.metadata.columnList.last_module_id.enumList=[];var self=this;response.data.forEach(function(item){self.metadata.columnList.first_module_id.enumList.push({value:item.id,rank:item.rank,name:item.rank+". "+item.name,disabled:true});self.metadata.columnList.last_module_id.enumList.push({value:item.id,rank:item.rank,name:item.rank+". "+item.name,disabled:true})})},updateModuleListState:function(firstEnumList,lastEnumList,prevStage,nextStage,firstModuleId,lastModuleId){if(angular.isUndefined(prevStage))prevStage=null;if(angular.isUndefined(nextStage))nextStage=null;var minModuleRank=angular.isDefined(firstEnumList[0].rank)?firstEnumList[0].rank:firstEnumList[1].rank;var maxModuleRank=firstEnumList[firstEnumList.length-1].rank;var firstModuleRank=angular.isDefined(firstModuleId)?firstEnumList.findByProperty("value",firstModuleId).rank:null;var lastModuleRank=angular.isDefined(lastModuleId)?lastEnumList.findByProperty("value",lastModuleId).rank:null;var minRank=prevStage?prevStage.first_module_rank+1:1;var maxRank=!prevStage?minModuleRank:nextStage?nextStage.last_module_rank-1:1e6;if(lastModuleRank&&lastModuleRank<maxRank)maxRank=lastModuleRank;firstEnumList.forEach(function(item){item.disabled=angular.isDefined(item.rank)&&!(minRank<=item.rank&&item.rank<=maxRank)});var minRank=!nextStage?maxModuleRank:prevStage?prevStage.first_module_rank:1;if(firstModuleRank&&firstModuleRank>minRank)minRank=firstModuleRank;var maxRank=nextStage?nextStage.last_module_rank-1:1e6;lastEnumList.forEach(function(item){item.disabled=angular.isDefined(item.rank)&&!(minRank<=item.rank&&item.rank<=maxRank)})}})};return{root:new object(true),instance:function(){return new object(false)}}}])});
