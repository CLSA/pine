define(function(){"use strict";try{var module=cenozoApp.module("page",true)}catch(err){console.warn(err);return}cenozoApp.initQnairePartModule(module,"page");module.identifier.parent={subject:"module",column:"module.id"};module.addInput("","note",{title:"Note",type:"text"});module.addInput("","qnaire_id",{column:"qnaire.id",isExcluded:true});module.addInput("","qnaire_name",{column:"qnaire.name",isExcluded:true});module.addInput("","base_language",{column:"base_language.code",isExcluded:true});module.addInput("","descriptions",{isExcluded:true});module.addInput("","module_descriptions",{isExcluded:true});module.addInput("","module_id",{isExcluded:true});module.addInput("","parent_name",{column:"module.name",isExcluded:true});module.addExtraOperation("view",{title:"Preview",operation:function($state,model){$state.go("page.render",{identifier:model.viewModel.record.getIdentifier()},{reload:true})}});function parseDescriptions(descriptionList){var code=null;return descriptionList.split("`").reduce(function(list,part){if(null==code){code=part}else{list[code]=part;code=null}return list},{})}function searchOptionList(optionList,id){var optionIndex=null;if(angular.isArray(optionList))optionList.some(function(option,index){if(option==id||angular.isObject(option)&&option.id==id){optionIndex=index;return true}});return optionIndex}cenozo.providers.directive("cnPageRender",["CnPageModelFactory","CnTranslationHelper","CnSession","CnHttpFactory","$q","$state","$document",function(CnPageModelFactory,CnTranslationHelper,CnSession,CnHttpFactory,$q,$state,$document){return{templateUrl:module.getFileUrl("render.tpl.html"),restrict:"E",scope:{model:"=?"},controller:function($scope){function isNumpadInput(event){return["render","run"].includes($scope.model.getActionFromState())&&(13==event.which&&"NumpadEnter"==event.code||97<=event.which&&event.which<=105)}$scope.data={page_id:null,qnaire_id:null,qnaire_name:null,base_language:null,title:null,uid:null};$scope.isComplete=false;if(angular.isUndefined($scope.model))$scope.model=CnPageModelFactory.root;$document.unbind("keyup.render");$document.bind("keyup.render",function(event){if(isNumpadInput(event)){event.stopPropagation();$scope.model.renderModel.onKeyup(13==event.which?"enter":event.which-96);$scope.$apply()}});$scope.validateKeydown=function(event){if(isNumpadInput(event)){event.returnValue=false;event.preventDefault()}};if(angular.isUndefined($scope.progress))$scope.progress=0;$scope.text=function(address,language){return CnTranslationHelper.translate(address,$scope.model.renderModel.currentLanguage)};function render(){var promiseList=[];if("response"!=$scope.model.getSubjectFromState()||null!=$scope.data.page_id)promiseList.push($scope.model.viewModel.onView(true).then(function(){$scope.data={page_id:$scope.model.viewModel.record.id,qnaire_id:$scope.model.viewModel.record.qnaire_id,qnaire_name:$scope.model.viewModel.record.qnaire_name,base_language:$scope.model.viewModel.record.base_language,title:$scope.model.viewModel.record.module_name,uid:null};$scope.progress=Math.round(100*$scope.model.viewModel.record.qnaire_page/$scope.model.viewModel.record.qnaire_pages);return $scope.model.renderModel.onLoad()}));$q.all(promiseList).then(function(){CnHttpFactory.instance({path:["qnaire",$scope.data.qnaire_id,"language"].join("/"),data:{select:{column:["id","code","name"]}}}).query().then(function(response){$scope.languageList=response.data});CnSession.setBreadcrumbTrail([{title:$scope.data.qnaire_name,go:function(){return $state.go("qnaire.view",{identifier:$scope.data.qnaire_id})}},{title:$scope.data.uid?$scope.data.uid:"Preview"},{title:$scope.data.title}]);if(null==$scope.model.renderModel.currentLanguage)$scope.model.renderModel.currentLanguage=$scope.data.base_language;$scope.isComplete=true})}if("response"!=$scope.model.getSubjectFromState())render();else{CnHttpFactory.instance({path:"response/token="+$state.params.token,data:{select:{column:["qnaire_id","page_id","submitted","introductions","conclusions",{table:"participant",column:"uid"},{table:"language",column:"code",alias:"base_language"},{table:"qnaire",column:"name",alias:"qnaire_name"},{table:"module",column:"name",alias:"module_name"}]}},onError:function(response){$state.go("error."+response.status,response)}}).get().then(function(response){$scope.data=response.data;$scope.data.introductions=parseDescriptions($scope.data.introductions);$scope.data.conclusions=parseDescriptions($scope.data.conclusions);$scope.data.title=null!=$scope.data.module_name?$scope.data.module_name:$scope.data.submitted?"Conclusion":"Introduction";render()})}}}}]);cenozo.providers.factory("CnPageRenderFactory",["CnHttpFactory","CnModalMessageFactory","$q","$state","$document","$transitions","$timeout",function(CnHttpFactory,CnModalMessageFactory,$q,$state,$document,$transitions,$timeout){var object=function(parentModel){var self=this;angular.extend(this,{parentModel:parentModel,questionList:[],optionListById:{},currentLanguage:null,keyQuestionIndex:null,pageComplete:false,writePromiseList:[],promiseIndex:0,runQuery:function(fn){return $q.all(this.writePromiseList).then(function(){var newIndex=self.promiseIndex++;var promise=fn().finally(function(){var index=self.writePromiseList.findIndexByProperty("index",newIndex);if(null!=index)self.writePromiseList.splice(index,1)});promise.index=newIndex;self.writePromiseList.push(promise);return promise})},convertValueToModel:function(question){if("boolean"==question.type){question.answer={yes:true===question.value,no:false===question.value}}else if("list"==question.type){var selectedOptions=angular.isArray(question.value)?question.value:[];question.answer={optionList:question.optionList.reduce(function(list,option){var optionIndex=searchOptionList(selectedOptions,option.id);list[option.id]=option.multiple_answers?{valueList:[]}:{selected:null!=optionIndex};if(option.extra){if(null!=optionIndex){list[option.id].valueList=option.multiple_answers?selectedOptions[optionIndex].value:[selectedOptions[optionIndex].value]}else{list[option.id].valueList=option.multiple_answers?[]:[null]}}return list},{})}}else{question.answer={value:angular.isString(question.value)||angular.isNumber(question.value)?question.value:null}}question.answer.dkna=angular.isObject(question.value)&&true===question.value.dkna;question.answer.refuse=angular.isObject(question.value)&&true===question.value.refuse},pageIsDone:function(){return!this.questionList.some(function(question){if(null==question.value)return true;if("list"==question.type){return angular.isArray(question.value)&&question.value.some(function(o){var option=self.optionListById[angular.isObject(o)?o.id:o];if(option.extra){if(option.multiple_answers){return!angular.isArray(o.value)||!o.value.some(function(value){return null!=value})}else{return null==o.value}}else{return null==o}})}})},onLoad:function(){return CnHttpFactory.instance({path:this.parentModel.getServiceResourcePath()+"/question",data:{select:{column:["rank","name","type","mandatory","dkna_refuse","minimum","maximum","descriptions"]}}}).query().then(function(response){var promiseList=[];angular.extend(self,{questionList:response.data,keyQuestionIndex:null,pageComplete:false});if(0<self.questionList.length&&angular.isDefined(self.questionList[0].language)){self.currentLanguage=self.questionList[0].language}self.questionList.forEach(function(question,questionIndex){question.descriptions=parseDescriptions(question.descriptions);question.value=angular.fromJson(question.value);question.backupValue=angular.copy(self.value);if(null==self.keyQuestionIndex&&"comment"!=question.type)self.keyQuestionIndex=questionIndex;if("list"==question.type){promiseList.push(CnHttpFactory.instance({path:["question",question.id,"question_option"].join("/"),data:{select:{column:["name","exclusive","extra","multiple_answers","descriptions"]},modifier:{order:"question_option.rank"}}}).query().then(function(response){question.optionList=response.data;question.optionList.forEach(function(option){option.descriptions=parseDescriptions(option.descriptions);self.optionListById[option.id]=option})}))}});return $q.all(promiseList).then(function(){self.questionList.forEach(question=>self.convertValueToModel(question));self.pageComplete=self.pageIsDone()})})},setLanguage:function(){if("response"==this.parentModel.getSubjectFromState()&&null!=this.currentLanguage){return this.runQuery(function(){return CnHttpFactory.instance({path:self.parentModel.getServiceResourcePath().replace("page/","response/")+"?action=set_language&code="+self.currentLanguage}).patch()})}},onKeyup:function(key){$q.all(this.writePromiseList).then(function(){if("enter"==key){if(self.pageComplete)self.proceed();return}if(null==self.keyQuestionIndex)return;var question=self.questionList[self.keyQuestionIndex];if("boolean"==question.type){var value=undefined;if(1==key)value=question.answer.yes?null:true;else if(2==key)value=question.answer.no?null:false;else if(3==key)value=question.answer.dkna?null:{dkna:true};else if(4==key)value=question.answer.refuse?null:{refuse:true};if(angular.isDefined(value))self.setAnswer(question,value)}else if("list"==question.type){if(key<=question.optionList.length){var option=question.optionList[key-1];if(question.answer.optionList[option.id].selected)self.removeOption(question,option);else self.addOption(question,option)}else if(key==question.optionList.length+1){self.setAnswer(question,question.answer.dkna?null:{dkna:true})}else if(key==question.optionList.length+2){self.setAnswer(question,question.answer.refuse?null:{refuse:true})}}else{if(1==key)self.setAnswer(question,question.answer.dkna?null:{dkna:true});else if(2==key)self.setAnswer(question,question.answer.refuse?null:{refuse:true})}do{self.keyQuestionIndex++;if(self.keyQuestionIndex==self.questionList.length)self.keyQuestionIndex=0}while("comment"==self.questionList[self.keyQuestionIndex].type)})},setAnswer:function(question,value){if(""===value)value=null;if("response"==self.parentModel.getSubjectFromState()){return this.runQuery(function(){return CnHttpFactory.instance({path:"answer/"+question.answer_id,data:{value:angular.toJson(value)}}).patch().then(function(){question.backupValue=angular.copy(question.value);question.value=value;self.pageComplete=self.pageIsDone();self.convertValueToModel(question);if("list"==question.type){for(var element of document.getElementsByName("answerValue")){var match=element.id.match(/option([0-9]+)value[0-9]+/);if(1<match.length){var optionId=match[1];if(null==searchOptionList(question.value,optionId))element.value=null}}}})})}return $q.all()},getValueForNewOption:function(question,option){var data=option.extra?{id:option.id,value:option.multiple_answers?[]:null}:option.id;var value=[];if(option.exclusive){value.push(data)}else{if(angular.isArray(question.value))value=question.value;value=value.filter(o=>!self.optionListById[angular.isObject(o)?o.id:o].exclusive);if(null==searchOptionList(value,option.id))value.push(data);value.sort(function(a,b){return(angular.isObject(a)?a.id:a)-(angular.isObject(b)?b.id:b)})}return value},addOption:function(question,option){console.log("add",question.id,option.id);this.setAnswer(question,this.getValueForNewOption(question,option)).then(function(){if(null!=option.extra)$timeout(function(){document.getElementById("option"+option.id+"value0").focus()},50)})},removeOption:function(question,option){console.log("remove",question.id,option.id);var value=angular.isArray(question.value)?question.value:[];var optionIndex=searchOptionList(value,option.id);if(null!=optionIndex)value.splice(optionIndex,1);if(0==value.length)value=null;this.setAnswer(question,value)},addAnswerValue:function(question,option){var value=angular.isArray(question.value)?question.value:[];var optionIndex=searchOptionList(value,option.id);if(null==optionIndex){value=this.getValueForNewOption(question,option);optionIndex=searchOptionList(value,option.id)}var valueIndex=value[optionIndex].value.indexOf(null);if(-1==valueIndex)valueIndex=value[optionIndex].value.push(null)-1;this.setAnswer(question,value).then(function(){$timeout(function(){document.getElementById("option"+option.id+"value"+valueIndex).focus()},50)})},removeAnswerValue:function(question,option,valueIndex){var value=question.value;var optionIndex=searchOptionList(value,option.id);value[optionIndex].value.splice(valueIndex,1);if(0==value[optionIndex].value.length)value.splice(optionIndex,1);if(0==value.length)value=null;this.setAnswer(question,value)},setAnswerValue:function(question,option,valueIndex,answerValue){console.log("set",question.id,option.id,valueIndex,answerValue);var value=question.value;var optionIndex=searchOptionList(value,option.id);if(null!=optionIndex){if(option.multiple_answers){if(0<answerValue.trim().length){var existingValueIndex=value[optionIndex].value.indexOf(answerValue);if(0<=existingValueIndex){document.getElementById("option"+option.id+"value"+valueIndex).value=null;var element=document.getElementById("option"+option.id+"value"+existingValueIndex);element.focus();element.select()}else{value[optionIndex].value[valueIndex]=answerValue}}else{value[optionIndex].value.splice(valueIndex,1)}}else{value[optionIndex].value=answerValue?answerValue:null}}this.setAnswer(question,value)},viewPage:function(){$state.go("page.view",{identifier:this.parentModel.viewModel.record.getIdentifier()},{reload:true})},renderPreviousPage:function(){$state.go("page.render",{identifier:this.parentModel.viewModel.record.previous_id},{reload:true})},renderNextPage:function(){$state.go("page.render",{identifier:this.parentModel.viewModel.record.next_id},{reload:true})},proceed:function(){return this.runQuery(function(){return CnHttpFactory.instance({path:"response/token="+$state.params.token+"?action=proceed"}).patch().then(function(){self.parentModel.reloadState(true)})})},backup:function(){return this.runQuery(function(){return CnHttpFactory.instance({path:"response/token="+$state.params.token+"?action=backup"}).patch().then(function(){self.parentModel.reloadState(true)})})}})};return{instance:function(parentModel,root){return new object(parentModel,root)}}}]);cenozo.providers.decorator("CnPageViewFactory",["$delegate",function($delegate){var instance=$delegate.instance;$delegate.instance=function(parentModel,root){var object=instance(parentModel,root);angular.extend(object,{onView:function(force){var self=this;return this.$$onView(force).then(function(){self.record.descriptions=parseDescriptions(self.record.descriptions);self.record.module_descriptions=parseDescriptions(self.record.module_descriptions)})}});return object};return $delegate}]);cenozo.providers.decorator("CnPageModelFactory",["$delegate","CnPageRenderFactory","$state",function($delegate,CnPageRenderFactory,$state){function extendModelObject(object){angular.extend(object,{renderModel:CnPageRenderFactory.instance(object),getServiceResourcePath:function(resource){return"response"==this.getSubjectFromState()?"page/token="+$state.params.token:this.$$getServiceResourcePath(resource)},getServiceCollectionPath:function(ignoreParent){var path=this.$$getServiceCollectionPath(ignoreParent);if("response"==this.getSubjectFromState())path=path.replace("response/undefined","module/token="+$state.params.token);return path}});return object}var instance=$delegate.instance;$delegate.root=extendModelObject($delegate.root);$delegate.instance=function(parentModel,root){return extendModelObject(instance(root))};return $delegate}])});
